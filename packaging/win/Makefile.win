# Makefile to build a Windows installer (taosetup.exe)
#
# Usage:
#   make
#   make prepare    # Prepare application in build_root
#   make clean

include Makefile.config
QMAKE_LIBDIR_QT_SANE="$(QMAKE_LIBDIR_QT:\\=/)"

# Path to the Nullsoft Scriptable Install System (NSIS) compiler
MAKENSIS = makensis
RM_RF = rm -rf
BITMAPS = inst_header.bmp uninst_header.bmp inst_welcome_finish.bmp uninst_welcome_finish.bmp

define run-nsis
$(MAKENSIS) -DOUTFILE=taosetup.exe tao.nsi
endef


all: tao_install $(BITMAPS) version.nsh
	$(run-nsis)

rn: $(BITMAPS) version.nsh
	$(run-nsis)

prepare tao_install:
	[ -d build_root ] || mkdir -p build_root
	cd ../.. && $(MAKE) install
	cp -Rp $(INSTROOT)/* build_root
	./copy_deps "$(QMAKE_LIBDIR_QT_SANE)"

clean:
	$(RM_RF) build_root/ taosetup.exe *.bmp .tao_install version.nsh

%.bmp:%.bmp.gz
	gunzip -c $< >$@

version.nsh: FORCE
	V=`git describe --tags --always --dirty=-dirty`; \
	(echo "; Generated by Makefile.win" ; echo "!define VERSION \"$$V\"") >version.nsh

FORCE:
